<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Narrative Nexus</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; font-src 'self' data: fonts.gstatic.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://jdefazmxvy.us18.qoddiapp.com"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
      }

      header {
        background-color: #333;
        padding: 40px;
        text-align: center;
      }

      header img {
        width: 200px;
        /* Adjust the size of the logo as needed */
      }

      .user-actions {
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .user-actions a {
        text-decoration: none;
        color: #000; /* Set black font color */
        margin-left: 20px;
        font-weight: bold;
        transition: color 0.3s; /* Add smooth color transition on hover */
        display: inline-block;
        padding: 10px 15px;
        background-color: #fff; /* Set white background color */
        border-radius: 5px; /* Add rounded corners */
      }

      .user-actions a:hover {
        color: #ff5733; /* Change color on hover (you can adjust the color as needed) */
      }

      .main-content {
        text-align: center;
        padding: 50px;
      }

      .content-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* This ensures the container takes up the full height of the viewport */
      }

      #scenarios {
        text-align: left;
        margin-top: 30px;
      }

      #generatedText {
        overflow: auto;
        /* or overflow: visible; */
        /* word-wrap: break-word; */
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      table,
      th,
      td {
        border: 1px solid #ddd;
      }

      th,
      td {
        padding: 15px;
        text-align: left;
      }

      th {
        background-color: #333;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <header>
      <!-- <img src="your_logo_image_url.png" alt="Narrative Nexus"> -->
      <div class="user-actions">
        <a href="userprofile.html">User Profile</a>
        <a onclick="logout()">Logout</a>
      </div>
    </header>

    <div class="content-container">
      <div class="main-content" id="main-content-user" style="display: none">
        <!-- Your main content goes here -->
        <h1>Welcome to Narrative Nexus</h1>
        <p>Explore the power of storytelling with us.</p>
        <br><br>

        <label for="input_title">Title: </label>
        <input type="text" id="input_title" name="input_title" required>

        <br>
        <label for="select_genre">Select Genre:</label>

        <select id="select_genre">
          <option value="superhero">Superhero</option>
          <option value="action">Action</option>
          <option value="drama">Drama</option>
          <option value="horror">Horror</option>
          <option value="thriller">Thriller</option>
          <option value="sci_fi">Sci-Fi</option></select
        ><br />

        <textarea id="textarea_story" cols="100" rows="15"></textarea>

        <br />
        <button id="button_generate_story" onclick="generateStory()">Generate Story</button>
        <button onclick="saveStory()">Save Story</button>
        <br />
        <br />

        <div id='div_generating' style="display: none;">
          monkeys are thinking...
        </div> 

        <div id="generatedText"></div>

        <br />
        <br />

        <div id="scenarios"></div>
        <div id="radio_button_scenarios"></div>
        <div id="feedback"></div>
      </div>

      <div class="main-content" id="main-content-admin" style="display: none">
        <h2>Users Data</h2>
        <table id="userTable">
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Hash</th>
            <th>Role</th>
            <th>Firstname</th>
            <th>Username</th>
          </tr>
        </table>
      </div>
    </div>

    <script>
      const endPointRoot = "https://jdefazmxvy.us18.qoddiapp.com";
      let savedStory = "";

      let userData = "";

      getUsersInfo()
        .then(async (data) => {


          if (data.statusCode == 401) {
            window.location.href = "index.html";
          }

          userData = data;

          if (data.role === "ADMIN") {
            document.getElementById("main-content-admin").style.display =
              "inline-block";
            const usersCount = await getUsersCount();
            showUserData(usersCount);
            
          } else {
            document.getElementById("main-content-user").style.display =
              "inline-block";
          }
        })
        .catch((error) => console.error("Error checking user role:", error));

      function logout() {
        const xhttp = new XMLHttpRequest();
        const stringEndPoint = "/api/v1/auth/logout";

        xhttp.open("GET", endPointRoot + stringEndPoint, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.withCredentials = true;
        xhttp.send();

        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status === 200) {
              const jsonData = JSON.parse(this.response);
              console.log(jsonData);

              // Redirect to landing.html after successful logout
              window.location.href = "index.html";
            }
          }
        };
      }

      function generateStory() {
        const xhttp = new XMLHttpRequest();
        const endPoint = "/api/v1/story/generateStory";
        // references to the story and genre
        const TEXTAREA_STORY = document.getElementById("textarea_story");
        const SELECT_GENRE = document.getElementById("select_genre");
        const DIV_RADIO_BUTTONS = document.getElementById("radio_button_scenarios");
        const BUTTON_GENERATE_STORY = document.getElementById("button_generate_story");
        const DIV_GENERATING = document.getElementById("div_generating");
        const generatedTextElement = document.getElementById("generatedText");
        const scenariosElement = document.getElementById("scenarios");

        // Get values
        const current_story = TEXTAREA_STORY.value;
        const current_genre = SELECT_GENRE.value;

        // Disable button to prevent spamming
        BUTTON_GENERATE_STORY.disabled = true;
        // Show api call indicator;
        DIV_GENERATING.style.display = 'block';

        // User has not given any input
        if (current_story.length < 1) {
          alert("Enter some input.");
          BUTTON_GENERATE_STORY.disabled = false;
          DIV_GENERATING.style.display = 'none';
        } else {
          // Set the data for the post request
          const data = {
            sentence: current_story,
            genre: current_genre,
          };

          xhttp.open("POST", endPointRoot + endPoint, true);
          xhttp.setRequestHeader("Content-Type", "application/json");
          xhttp.withCredentials = true;

          console.log("Data: ", data);
          xhttp.send(JSON.stringify(data));

          xhttp.onreadystatechange = function () {
            if (this.readyState === 4) {
              if (this.status === 201) {
                const jsonData = JSON.parse(this.response);
                console.log("Return data: ", jsonData);

                const updated_story = jsonData[0].generated_text;
                const scenarios = jsonData[1];

                // Set text area with updated story
                TEXTAREA_STORY.value = updated_story;

                // Clear the generated scenarios.
                scenariosElement.innerHTML = "";
                DIV_RADIO_BUTTONS.innerHTML = "";
                // Display all scenarios
                Object.keys(scenarios).forEach((scenarioKey) => {
                  scenariosElement.innerText += `${scenarioKey}: ${scenarios[scenarioKey]}\n`;
                });

                createScenarioRadioButtons(
                  scenarios,
                  updated_story,
                  TEXTAREA_STORY
                );

                BUTTON_GENERATE_STORY.disabled = false;
                DIV_GENERATING.style.display = 'none';
              } else {
                BUTTON_GENERATE_STORY.disabled = false;
                DIV_GENERATING.style.display = 'none';
              }
            }
          };
        }
      }

      function createScenarioRadioButtons(
        scenarios,
        current_story,
        textarea_element
      ) {
        const DIV_RADIO_BUTTONS = document.getElementById(
          "radio_button_scenarios"
        );

        Object.keys(scenarios).forEach(function (scenarioKey) {
          const radioBtn = document.createElement("input");
          radioBtn.type = "radio";
          radioBtn.name = "scenario";
          radioBtn.value = scenarioKey;
          radioBtn.id = scenarioKey;

          radioBtn.addEventListener("change", function () {
            appendScenario(scenarioKey, current_story);
          });

          const label = document.createElement("label");
          label.htmlFor = scenarioKey;
          label.textContent = "Scenario " + scenarioKey.slice(-1);

          DIV_RADIO_BUTTONS.appendChild(radioBtn);
          DIV_RADIO_BUTTONS.appendChild(label);
          DIV_RADIO_BUTTONS.appendChild(document.createElement("br"));
        });

        function appendScenario(selectedScenarioKey, current_story) {
          const selectedScenario = scenarios[selectedScenarioKey];
          textarea_element.value = current_story + ". " + selectedScenario;
        }
      }

      function getUsersInfo() {
        return fetch(endPointRoot + "/api/v1/auth/me", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((jsonData) => jsonData)
          .catch((error) => {
            console.error("Error checking user role:", error);
            return jsonData;
          });
      }

      function saveStory() {
        // const feedback = document.getElementById("feedback")
        // const generatedText = document.getElementById("generatedText").innerText;
        const TEXTAREA_STORY = document.getElementById("textarea_story");
        const SELECT_GENRE = document.getElementById("select_genre");
        const INPUT_TITLE = document.getElementById("input_title");

        const savedStory = TEXTAREA_STORY.value;
        const savedGenre = SELECT_GENRE.value;
        const savedTitle = INPUT_TITLE.value;

        const xhttp = new XMLHttpRequest();
        const endPoint = "/api/v1/story/savestory";
        xhttp.open("POST", endPointRoot + endPoint, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.withCredentials = true;
        
        const savedData = {
          title: savedTitle,
          story: savedStory,
          genre: savedGenre,
          username: userData.username,
        };
        console.log(savedData);

        xhttp.send(JSON.stringify(savedData));

        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status === 201) {
              const jsonData = JSON.parse(this.response);
              feedback.innerText = `Saved!\n
            ID: ${jsonData.id}\n
            Title: ${jsonData.title}\n
            Genre: ${jsonData.genre}\n
            Story: ${jsonData.story}\n 
            Saved at: ${jsonData.updatetime}`;
            }
          }
        };
      }

      function getUsersCount() {
        const endPoint = "/api/v1/user/allusertotalrequest";

        return fetch(endPointRoot + endPoint, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((jsonData) => {
            // console.log(jsonData)

            return jsonData;
          });

      }

      function showUserData(usersCount) {

        console.log(usersCount);
        const table = document.getElementById("userTable");

        const endPoint = "/api/v1/user/getallusers";

        fetch(endPointRoot + endPoint, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((jsonData) => {
            table.innerHTML =
              "<tr><th>ID</th><th>Email</th><th>Firstname</th><th>Username</th><th>Role</th><th>API Count</th></tr>";

            jsonData.data.forEach((user) => {
              const row = table.insertRow();
              row.insertCell(0).innerText = user.id;
              row.insertCell(1).innerText = user.email;
              row.insertCell(2).innerText = user.firstname;
              row.insertCell(3).innerText = user.username;
              row.insertCell(4).innerText = user.role;

              const matchingUserCount = usersCount.find(
                (countData) => countData.username === user.username
              )
              row.insertCell(5).innerText = matchingUserCount ? matchingUserCount.count : 0;
            });
          })
          .catch((error) => console.error("Error fetching user data:", error));
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Narrative Nexus</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; font-src 'self' data: fonts.gstatic.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https://jdefazmxvy.us18.qoddiapp.com"
    />

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
      }

      header {
        background-color: #333;
        padding: 20px;
        text-align: center;
      }

      header img {
        width: 200px; /* Adjust the size of the logo as needed */
      }

      .user-actions {
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .user-actions a {
        text-decoration: none;
        color: #fff;
        margin-left: 20px;
        font-weight: bold;
      }

      .main-content {
        text-align: center;
        padding: 50px;
      }

      #scenarios {
        text-align: left;
        margin-top: 30px;
      }

      #generatedText {
        overflow: auto; /* or overflow: visible; */
        /* word-wrap: break-word; */
      }
    </style>
  </head>
  <body>
    <header>
      <!-- <img src="your_logo_image_url.png" alt="Narrative Nexus"> -->
      <div class="user-actions">
        <a href="userprofile.html">User Profile</a>
        <a onclick="logout()">Logout</a>
      </div>
    </header>

    <div class="main-content">
      <!-- Your main content goes here -->
      <h1>Welcome to Narrative Nexus</h1>
      <p>Explore the power of storytelling with us.</p>
      <button onclick="generateStory()">Generate Story</button>
      <button onclick="saveStory()">Save Story</button>
      <br />
      <br />

      <div id="generatedText"></div>

      <br />
      <br />
      <div id="scenarios"></div>

      <div id="feedback"></div>
    </div>

    <script>
      const endPointRoot = "https://jdefazmxvy.us18.qoddiapp.com";
      let savedStory = "";

      let userData = "";

      getUsersInfo()
        .then((data) => {
            userData = data
        })


      function logout() {
        const xhttp = new XMLHttpRequest();
        const stringEndPoint = "/api/v1/auth/logout";

        xhttp.open("GET", endPointRoot + stringEndPoint, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.withCredentials = true;
        xhttp.send();

        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status === 200) {
              const jsonData = JSON.parse(this.response);
              console.log(jsonData);

              // Redirect to landing.html after successful logout
              window.location.href = "index.html";
            }
          }
        };
      }

      function generateStory(params) {
        const xhttp = new XMLHttpRequest();
        const endPoint = "/api/v1/story/generateStory";
        const generatedTextElement = document.getElementById("generatedText");
        const scenariosElement = document.getElementById("scenarios");

        const data = {
          sentence: "",
          genre: "",
        };

        if (params) {
          data.sentence = params;
          data.genre = "superhero";
        } else {
          data.sentence = "I am Batman, ";
          data.genre = "superhero";
        }

        xhttp.open("POST", endPointRoot + endPoint, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.withCredentials = true;

        console.log("Data: ", data);
        xhttp.send(JSON.stringify(data));

        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status === 201) {
              const jsonData = JSON.parse(this.response);
              console.log("Return data: ", jsonData);

            //   let sentenceGenerated = jsonData[0].generated_text;

            //   if (!sentenceGenerated.endsWith(".")) {
            //     sentenceGenerated += ".";
            //   }

              generatedTextElement.innerHTML = jsonData[0].generated_text;

              // Display scenarios with buttons
              const scenarios = jsonData[1];
              scenariosElement.innerHTML = `
                <button onclick="combineAndLog('${scenarios.scenario1}')">'${scenarios.scenario1}'</button>
                <button onclick="combineAndLog('${scenarios.scenario2}')">'${scenarios.scenario2}'</button>
                <button onclick="combineAndLog('${scenarios.scenario3}')">'${scenarios.scenario3}'</button>
              `;
            }
          }
        };
      }



      function combineAndLog(scenarioText) {
        const generatedText =
          document.getElementById("generatedText").innerText;
        const combinedText = `${generatedText} ${scenarioText}`;
        console.log(combinedText);
        generateStory(combinedText);
      }

      function getUsersInfo() {
        return fetch(endPointRoot + "/api/v1/auth/me", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
        })
          .then((response) => response.json())
          .then((jsonData) => jsonData)
          .catch((error) => {
            console.error("Error checking user role:", error);
            return jsonData;
          });
      }

      function saveStory() {
        const feedback = document.getElementById("feedback")
        const generatedText = document.getElementById("generatedText").innerText;
        savedStory = generatedText;
        const xhttp = new XMLHttpRequest();
        const endPoint = "/api/v1/story/savestory";
        xhttp.open("POST", endPointRoot + endPoint, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.withCredentials = true;

        const savedData = {
            story: savedStory,
            genre: "superhero",
            username: userData.username
        }
        xhttp.send(JSON.stringify(savedData))

        xhttp.onreadystatechange = function () {
          if (this.readyState === 4) {
            if (this.status === 201) {
              const jsonData = JSON.parse(this.response);
              feedback.innerText = `${jsonData.id} ${jsonData.story} ${jsonData.genre} ${jsonData.updatetime}`;
            }
          }
        };



      }


    </script>
  </body>
</html>
